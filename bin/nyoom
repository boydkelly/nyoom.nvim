#!/usr/bin/env bash

set -o errexit -o pipefail -o nounset
# people like xdg
NVIM_APPNAME="${NVIM_APPNAME:-nvim}"
export NVIM_APPNAME=nvim-nyoom
CONFIG_PATH="${XDG_CONFIG_HOME:-${HOME}/.config}/${NVIM_APPNAME}"
CACHE_PATH="${XDG_CACHE_HOME:-${HOME}/.cache}/${NVIM_APPNAME}"
DATA_PATH="${XDG_DATA_HOME:-${HOME}/.local/share}/${NVIM_APPNAME}"
NYOOM_CONFIG="${XDG_DATA_HOME:-${HOME}/.config}/nyoom"
export NYOOM_CLI=true
echo $NYOOM_CONFIG

NYOOM_CURRENT_DIR_REAL=$(realpath "$(pwd)")
NYOOM_BASENAME=$(basename "$NYOOM_CURRENT_DIR_REAL")

if [[ "$NYOOM_CURRENT_DIR_REAL" != "$CONFIG_PATH" ]]; then
  echo "The directory you're running bin/nyoom ${1:-} in is not the expected location."
  echo
  read -p "Set NVIM_APPNAME=${NYOOM_BASENAME} before continuing?  " -n 1 -r
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    NVIM_APPNAME=$NYOOM_BASENAME
  else
    echo ""
    echo "Please clone Nyoom to ~/.config/nvim or run this command as 'NVIM_APPNAME=${NYOOM_BASENAME} bin/nyoom ${1:-}'"
    exit
  fi

fi

mkdir -p "$CONFIG_PATH" "$CACHE_PATH" "$DATA_PATH" "$NYOOM_CONFIG"

# silently enter ${CONFIG_PATH} when updating
pushd ${CONFIG_PATH} >/dev/null

function print_nyoom_status() {
  printf "\033[1m\033[36mNyoom version:\033[0m $(git log --pretty=tformat:"%h" -n1)\n"
  nvim --version | sed '/^$/,$d'
  echo
}

function install_nyoom() {
  if [ -d "${NYOOM_CONFIG}/" ]; then
    printf "\n\033[1m\033[32mNyoom Dir Already Exists\033[0m\n"
  else
    printf "Linking Nyoom Configs ..."
    mkdir -p "${NYOOM_CONFIG}/fnl"
    [ ! -f "${NYOOM_CONFIG}/config.fnl" ] && ln -s "${CONFIG_PATH}/fnl/config.fnl" "${NYOOM_CONFIG}/config.fnl"
    [ ! -f "${NYOOM_CONFIG}/modules.fnl" ] && ln -s "${CONFIG_PATH}/fnl/modules.fnl" "${NYOOM_CONFIG}/modules.fnl"
    [ ! -f "${NYOOM_CONFIG}/packages.fnl" ] && ln -s "${CONFIG_PATH}/fnl/packages.fnl" "${NYOOM_CONFIG}/packages.fnl"
    printf "\n\033[1m\033[32mSuccessfully Linked Nyoom Configs\033[0m\n\n"
  fi
  printf "Installing Core Dependencies..."
  nvim --headless -c 'lua vim.pack.add({"https://github.com/udayvir-singh/tangerine.nvim", \
	"https://github.com/nyoom-engineering/oxocarbon.nvim", \
  "https://github.com/nvim-neorocks/lz.n" })' +qa

  printf "\n\033[1m\033[32mSuccessfully Installed Core Dependencies\033[0m\n\n"
}

function help() {
  printf "%s\n%s\n  %s\n%s\n" \
    "usage: $(basename "$0") [options] [script [args]]" \
    "Available options are:" \
    "install  install core plugins" \
    "sync  sync nyoom modules, plugins, and dependencies (linters/formatters/parsers/language-servers)" \
    "lock  generate lockfile for installed plugins (unstable)" \
    "upgrade  upgrade Nyoom Nvim" \
    "profile  run Nyoom Nvim with profilers enabled at startuptime"
}

case "${1:-}" in
"")
  help
  ;;
help)
  help
  ;;
status)
  print_nyoom_status
  ;;
install)
  # test force installl for now
  rm -rf "${DATA_PATH}/site/pack/core/opt"
  if [ -d "${DATA_PATH}/site/pack/core/opt/tangerine.nvim" ] && [ -d "${DATA_PATH}/site/pack/core/opt/lz.n" ]; then
    printf "\n\033[1m\033[32mCore Dependencies are Already Installed\033[0m\n"
  else
    install_nyoom
  fi
  ;;
sync)
  start_time=$(date +%s)
  printf "Synchronizing your config with Nyoom Nvim\n\n"
  print_nyoom_status
  if [ ! -d "${DATA_PATH}/site/pack/core/opt/tangerine.nvim" ] || [ ! -d "${DATA_PATH}/site/pack/core/opt/lz.n" ]; then
    printf "Core Dependencies Unavailable, running 'nyoom install'\n"
    install_nyoom
  fi
  # printf "Clearing cache"
  #rm -f "${CONFIG_PATH}/lua/packer_compiled.lua" || true

  NYOOM_CLI=true nvim --headless -c 'lua vim.pack.update()' +qa
  #export NVIM_APPNAME="nvim-nyoom"
  #-b nyoom
  echo
  if [ -d "${DATA_PATH}/site/pack/core/opt/nvim-treesitter/" ]; then
    echo
    read -p "Would you like to sync tree-sitter parsers for enabled modules? y/n: " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      ts_time=$(date +%s)
      printf "\nSyncing Tree-sitter Parsers (this may take a while)\n"
      nvim --headless \
        -c "lua dofile(vim.fn.stdpath('config') .. '/.nyoom/modules/tools/tree-sitter/config.lua')" \
        -c "TSUpdateSync" \
        -c "qall"
      printf "\n\033[1m\033[36mNyoom successfully synced parsers in $(expr $(date +%s) - $ts_time)s\033[0m\n"
    fi
  else
    printf "\nTree-sitter module disabled: skipping"
  fi
  if [ -d "${DATA_PATH}/site/pack/core/opt/mason.nvim/" ]; then
    echo
    read -p "Would you like to sync tooling for enabled modules through Mason (language-servers, formatters, and linters)? y/n: " -n 1 -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      mason_time=$(date +%s)
      printf "\nSyncing tooling (this may take a while)\n"
      nvim --headless -c 'Mason' -c 'qall'
      printf "\n\033[1m\033[36mNyoom successfully synced tooling in $(expr $(date +%s) - $mason_time)s\033[0m\n"
    fi
  else
    printf "\nMason module disabled: skipping"
  fi
  printf "\n\033[1m\033[92mNyoom successfully synced dependencies in $(expr $(date +%s) - $start_time)s\033[0m\n\n"
  # else
  # 	printf "\n\033[31mError: Lockfile not available. Please run 'nyoom lock'\033[0m\n"
  # 	printf "\033[1m\033[92mNyoom unsuccessfully synced plugins in $(expr $(date +%s) - $start_time)s\033[0m\n\n"
  # fi
  ;;
lock)
  if [ -e "${CONFIG_PATH}/lua/nvim-pack-lock.lua" ]; then
    true
  else
    false
  fi
  ;;
upgrade)
  printf "\033[1mUpdating Nyoom\033[0m\n"
  git fetch
  if [ $(git rev-parse HEAD) == $(git rev-parse @{u}) ]; then
    printf "Up-to-date\n\n"
    exit
  fi
  printf "\033[36mCurrent Nyoom version $(git log --pretty=tformat:"%h" -n1)\033[0m\n"
  printf "Here's what you've missed:\n"
  git log HEAD..origin/main
  read -p "Continue updating? y/n" -n 1 -r
  echo
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    start_time=$(date +%s)
    printf "\nUpdating Nyoom\n"
    git pull
    printf "\033[1m\033[92mNyoom successfully updated to version $(git log --pretty=tformat:"%h" -n1) in $(expr $(date +%s) - $start_time)s\033[0m\n"
    printf "Run 'nyoom sync' to syncronize modules\n\n"
  fi
  ;;
repl)
  printf "\nFennel Repl with Nyoom Nvim\n\n"
  print_nyoom_status
  exec nvim --headless -S "${CONFIG_PATH}/fnl/core/repl.fnl" -c 'echo""|qall!'
  ;;
profile)
  NYOOM_PROFILE=true nvim
  ;;
*)
  # printf "\nRunning File with Nyoom Nvim\n\n"
  # print_nyoom_status
  exec nvim --headless -S "$1" -i NONE -c 'echo""|qall!' -- "${@:2}"
  ;;
esac
popd >/dev/null
